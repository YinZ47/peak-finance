{% extends "base.html" %}

{% block title %}Dashboard - Peak Finance{% endblock %}

{% block content %}
<section class="dashboard-section">
    <div class="container">
        <div class="dashboard-header">
            <h1>Financial Dashboard</h1>
            <p>Your complete financial overview</p>
        </div>

        <!-- Dashboard content will be loaded via JavaScript -->
        <div id="dashboardContent">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading your financial data...</p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Check auth on page load
if (!Auth.isAuthenticated()) {
    window.location.href = '/auth';
}

const dashboardContent = document.getElementById('dashboardContent');

function renderDashboard(summary) {
    const debtEtaText = summary.debt_payoff_eta_months !== null && summary.debt_payoff_eta_months !== undefined
        ? `${summary.debt_payoff_eta_months} month${summary.debt_payoff_eta_months === 1 ? '' : 's'}`
        : 'No active debt goals yet';

    const goalProgress = summary.goal_progress_pct || 0;
    const funRatio = summary.total_income > 0 ? (summary.fun_budget / summary.total_income) : 0;

    dashboardContent.innerHTML = `
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>Total Income</h3>
                <p class="metric-value">${formatCurrency(summary.total_income)}</p>
                <p class="metric-sub">Monthly net income</p>
            </div>
            <div class="dashboard-card">
                <h3>Total Expenses</h3>
                <p class="metric-value">${formatCurrency(summary.total_expenses)}</p>
                <p class="metric-sub">Tracked essential + variable</p>
            </div>
            <div class="dashboard-card highlight">
                <h3>Monthly Surplus</h3>
                <p class="metric-value">${formatCurrency(summary.surplus)}</p>
                <p class="metric-sub">After debt and expenses</p>
            </div>
            <div class="dashboard-card">
                <h3>Debt-to-Income</h3>
                <p class="metric-value">${formatPercent(summary.dti)}</p>
                <p class="metric-sub">Target &lt; 35%</p>
            </div>
        </div>

        <div class="dashboard-grid secondary">
            <div class="dashboard-card">
                <h3>Safe to Spend</h3>
                <p class="metric-value">${formatCurrency(summary.safe_to_spend)}</p>
                <p class="metric-sub">Discretionary buffer this month</p>
            </div>
            <div class="dashboard-card">
                <h3>Fun Budget</h3>
                <p class="metric-value">${formatCurrency(summary.fun_budget)}</p>
                <p class="metric-sub">${formatPercent(funRatio)}</p>
            </div>
            <div class="dashboard-card">
                <h3>Goal Progress</h3>
                <div class="progress-bar" role="progressbar"
                     aria-valuenow="${goalProgress}" aria-valuemin="0" aria-valuemax="100">
                    <span style="width: ${Math.min(goalProgress, 100)}%"></span>
                </div>
                <p class="metric-sub">${goalProgress.toFixed(1)}% of targets saved</p>
            </div>
            <div class="dashboard-card">
                <h3>Debt Payoff ETA</h3>
                <p class="metric-value">${debtEtaText}</p>
                <p class="metric-sub">Based on current EMI totals</p>
            </div>
        </div>

        <div class="dashboard-actions">
            <h3>Next steps</h3>
            <p>Jump into the tools to add expenses, plan loans, or explore features.</p>
            <div class="action-buttons">
                <a class="btn btn-primary" href="/#features">Explore Features</a>
                <a class="btn btn-outline" href="/#tools">Open Calculators</a>
                <a class="btn btn-outline" href="/">Back to Home</a>
            </div>
        </div>
    `;
}

function showDashboardError(message) {
    dashboardContent.innerHTML = `
        <div class="dashboard-error">
            <i class="fas fa-circle-exclamation"></i>
            <p>${message}</p>
            <button class="btn btn-primary" id="retryDashboard">Retry</button>
        </div>
    `;

    document.getElementById('retryDashboard')?.addEventListener('click', loadDashboard);
}

function loadDashboard() {
    dashboardContent.innerHTML = `
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading your financial data...</p>
        </div>
    `;

    API.get('/calc/dashboard')
        .then(renderDashboard)
        .catch((error) => {
            const message = error?.message || 'Failed to load dashboard';
            showDashboardError(message);
            showToast(message, 'error');
        });
}

loadDashboard();
</script>
{% endblock %}